
(function($){var delimiter=new Array();var tags_callbacks=new Array();$.fn.doAutosize=function(o){var minWidth=$(this).data('minwidth'),maxWidth=$(this).data('maxwidth'),val='',input=$(this),testSubject=$('#'+$(this).data('tester_id'));if(val===(val=input.val())){return;}
var escaped=val.replace(/&/g,'&amp;').replace(/\s/g,' ').replace(/</g,'&lt;').replace(/>/g,'&gt;');testSubject.html(escaped);var testerWidth=testSubject.width(),newWidth=(testerWidth+o.comfortZone)>=minWidth?testerWidth+o.comfortZone:minWidth,currentWidth=input.width(),isValidWidthChange=(newWidth<currentWidth&&newWidth>=minWidth)||(newWidth>minWidth&&newWidth<maxWidth);if(isValidWidthChange){input.width(newWidth);}};$.fn.resetAutosize=function(options){var minWidth=$(this).data('minwidth')||options.minInputWidth||$(this).width(),maxWidth=$(this).data('maxwidth')||options.maxInputWidth||($(this).closest('.tagsinput').width()-options.inputPadding),val='',input=$(this),testSubject=$('<tester/>').css({position:'absolute',top:-9999,left:-9999,width:'auto',fontSize:input.css('fontSize'),fontFamily:input.css('fontFamily'),fontWeight:input.css('fontWeight'),letterSpacing:input.css('letterSpacing'),whiteSpace:'nowrap'}),testerId=$(this).attr('id')+'_autosize_tester';if(!$('#'+testerId).length>0){testSubject.attr('id',testerId);testSubject.appendTo('body');}
input.data('minwidth',minWidth);input.data('maxwidth',maxWidth);input.data('tester_id',testerId);input.css('width',minWidth);};$.fn.addTag=function(value,options){options=jQuery.extend({focus:false,callback:true},options);this.each(function(){var id=$(this).attr('id');var tagslist=$(this).val().split(delimiter[id]);if(tagslist[0]==''){tagslist=new Array();}
value=jQuery.trim(value);if(options.unique){var skipTag=$(tagslist).tagExist(value);if(skipTag==true){$('#'+id+'_tag').addClass('not_valid');}}else{var skipTag=false;}
if(value!=''&&skipTag!=true){$('<span>').addClass('tag').append($('<span>').text(value).append('&nbsp;&nbsp;'),$('<a>',{href:'#',title:'Removing tag',text:'x'}).click(function(){return $('#'+id).removeTag(escape(value));})).insertBefore('#'+id+'_addTag');tagslist.push(value);$('#'+id+'_tag').val('');if(options.focus){$('#'+id+'_tag').focus();}else{$('#'+id+'_tag').blur();}
$.fn.tagsInput.updateTagsField(this,tagslist);if(options.callback&&tags_callbacks[id]&&tags_callbacks[id]['onAddTag']){var f=tags_callbacks[id]['onAddTag'];f.call(this,value);}
if(tags_callbacks[id]&&tags_callbacks[id]['onChange'])
{var i=tagslist.length;var f=tags_callbacks[id]['onChange'];f.call(this,$(this),tagslist[i-1]);}}});return false;};$.fn.removeTag=function(value){value=unescape(value);this.each(function(){var id=$(this).attr('id');var old=$(this).val().split(delimiter[id]);$('#'+id+'_tagsinput .tag').remove();str='';for(i=0;i<old.length;i++){if(old[i]!=value){str=str+delimiter[id]+old[i];}}
$.fn.tagsInput.importTags(this,str);if(tags_callbacks[id]&&tags_callbacks[id]['onRemoveTag']){var f=tags_callbacks[id]['onRemoveTag'];f.call(this,value);}});return false;};$.fn.tagExist=function(val){return(jQuery.inArray(val,$(this))>=0);};$.fn.importTags=function(str){id=$(this).attr('id');$('#'+id+'_tagsinput .tag').remove();$.fn.tagsInput.importTags(this,str);}
$.fn.tagsInput=function(options){var settings=jQuery.extend({interactive:true,defaultText:'add a tag',minChars:0,width:'300px',height:'100px',autocomplete:{selectFirst:false},'hide':true,'delimiter':',','unique':true,removeWithBackspace:true,placeholderColor:'#666666',autosize:true,comfortZone:20,inputPadding:6*2},options);this.each(function(){if(settings.hide){$(this).hide();}
var id=$(this).attr('id')
var data=jQuery.extend({pid:id,real_input:'#'+id,holder:'#'+id+'_tagsinput',input_wrapper:'#'+id+'_addTag',fake_input:'#'+id+'_tag'},settings);delimiter[id]=data.delimiter;if(settings.onAddTag||settings.onRemoveTag||settings.onChange){tags_callbacks[id]=new Array();tags_callbacks[id]['onAddTag']=settings.onAddTag;tags_callbacks[id]['onRemoveTag']=settings.onRemoveTag;tags_callbacks[id]['onChange']=settings.onChange;}
var markup='<div id="'+id+'_tagsinput" class="tagsinput"><div id="'+id+'_addTag">';if(settings.interactive){markup=markup+'<input id="'+id+'_tag" value="" data-default="'+settings.defaultText+'" />';}
markup=markup+'</div><div class="tags_clear"></div></div>';$(markup).insertAfter(this);$(data.holder).css('width',settings.width);$(data.holder).css('height',settings.height);if($(data.real_input).val()!=''){$.fn.tagsInput.importTags($(data.real_input),$(data.real_input).val());}
if(settings.interactive){$(data.fake_input).val($(data.fake_input).attr('data-default'));$(data.fake_input).css('color',settings.placeholderColor);$(data.fake_input).resetAutosize(settings);$(data.holder).bind('click',data,function(event){$(event.data.fake_input).focus();});$(data.fake_input).bind('focus',data,function(event){if($(event.data.fake_input).val()==$(event.data.fake_input).attr('data-default')){$(event.data.fake_input).val('');}
$(event.data.fake_input).css('color','#000000');});if(settings.autocomplete_url!=undefined){autocomplete_options={source:settings.autocomplete_url};for(attrname in settings.autocomplete){autocomplete_options[attrname]=settings.autocomplete[attrname];}
if(jQuery.Autocompleter!==undefined){$(data.fake_input).autocomplete(settings.autocomplete_url,settings.autocomplete);$(data.fake_input).bind('result',data,function(event,data,formatted){if(data){$('#'+id).addTag(data[0]+"",{focus:true,unique:(settings.unique)});}});}else if(jQuery.ui.autocomplete!==undefined){$(data.fake_input).autocomplete(autocomplete_options);$(data.fake_input).bind('autocompleteselect',data,function(event,ui){$(event.data.real_input).addTag(ui.item.value,{focus:true,unique:(settings.unique)});return false;});}}else{$(data.fake_input).bind('blur',data,function(event){var d=$(this).attr('data-default');if($(event.data.fake_input).val()!=''&&$(event.data.fake_input).val()!=d){if((event.data.minChars<=$(event.data.fake_input).val().length)&&(!event.data.maxChars||(event.data.maxChars>=$(event.data.fake_input).val().length)))
$(event.data.real_input).addTag($(event.data.fake_input).val(),{focus:true,unique:(settings.unique)});}else{$(event.data.fake_input).val($(event.data.fake_input).attr('data-default'));$(event.data.fake_input).css('color',settings.placeholderColor);}
return false;});}
$(data.fake_input).bind('keypress',data,function(event){if(event.which==event.data.delimiter.charCodeAt(0)||event.which==13){event.preventDefault();if((event.data.minChars<=$(event.data.fake_input).val().length)&&(!event.data.maxChars||(event.data.maxChars>=$(event.data.fake_input).val().length)))
$(event.data.real_input).addTag($(event.data.fake_input).val(),{focus:true,unique:(settings.unique)});$(event.data.fake_input).resetAutosize(settings);return false;}else if(event.data.autosize){$(event.data.fake_input).doAutosize(settings);}});data.removeWithBackspace&&$(data.fake_input).bind('keydown',function(event)
{if(event.keyCode==8&&$(this).val()=='')
{event.preventDefault();var last_tag=$(this).closest('.tagsinput').find('.tag:last').text();var id=$(this).attr('id').replace(/_tag$/,'');last_tag=last_tag.replace(/[\s]+x$/,'');$('#'+id).removeTag(escape(last_tag));$(this).trigger('focus');}});$(data.fake_input).blur();if(data.unique){$(data.fake_input).keydown(function(event){if(event.keyCode==8||String.fromCharCode(event.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){$(this).removeClass('not_valid');}});}}
return false;});return this;};$.fn.tagsInput.updateTagsField=function(obj,tagslist){var id=$(obj).attr('id');$(obj).val(tagslist.join(delimiter[id]));};$.fn.tagsInput.importTags=function(obj,val){$(obj).val('');var id=$(obj).attr('id');var tags=val.split(delimiter[id]);for(i=0;i<tags.length;i++){$(obj).addTag(tags[i],{focus:false,callback:false});}
if(tags_callbacks[id]&&tags_callbacks[id]['onChange'])
{var f=tags_callbacks[id]['onChange'];f.call(obj,obj,tags[i]);}};})(jQuery);ttObjects={room:null,getRoom:function(){for(var memberName in turntable){var member=turntable[memberName];if(typeof member!=='object'||member===null)continue;if(typeof member.setupRoom!=='undefined'){ttObjects.room=member;return member;}}
return false;},manager:null,getManager:function(){for(var memberName in ttObjects.getRoom()){var member=ttObjects.room[memberName];if(typeof member!=='object'||member===null)continue;if(typeof member.blackswan!=='undefined'){ttObjects.manager=member;return member;}}
return false;},api:null,getApi:function(){var apiRegex=/ Preparing message /i;for(var memberName in turntable){var member=turntable[memberName];if(typeof member!=='function')continue;member.toString=Function.prototype.toString;if(apiRegex.test(member.toString())){ttObjects.api=member;return member;}}
return false;}};ttTools={loadRetry:30,load:function(retry){if(!turntable||!ttObjects.getManager()){if(retry>ttTools.loadRetry){return alert('Could not load ttTools.');}
var callback=function(){ttTools.load(retry++);}
return setTimeout(callback,1000);}
ttTools.init();},init:function(){$('<link/>',{type:'text/css',rel:'stylesheet',href:'http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/themes/sunny/jquery-ui.css'}).appendTo(document.head);this.roomChanged();this.views.menu.render();this.views.users.render();this.views.toolbar.render();this.tags.load(0);this.portability.init();turntable.addEventListener('auth',$.proxy(this.authEvent,this));turntable.addEventListener('message',$.proxy(this.messageEvent,this));turntable.addEventListener('reconnect',$.proxy(this.reconnectEvent,this));turntable.addEventListener('userinfo',$.proxy(this.userInfoEvent,this));this.checkVersion();},authEvent:function(message){console.warn(message);},messageEvent:function(message){if(typeof message.msgid!=='undefined')return;switch(message.command){case'speak':return this.userSpoke(message);break;case'update_votes':return this.votesUpdated(message);break;case'deregistered':return this.userRemoved(message);break;case'newsong':return this.songChanged(message);break;case'add_dj':return this.djAdded(message);break;case'booted_user':return this.userBooted(message);break;case'rem_dj':return this.djRemoved(message);break;case'registered':case'snagged':case'update_user':return;break;default:return console.warn(message);break;}
if(typeof message.users!=='undefined'&&typeof message.room==='object'&&typeof message.room.metadata==='object'&&typeof message.room.metadata.songlog!=='undefined')
return this.roomChanged();},reconnectEvent:function(message){console.warn(message);},userInfoEvent:function(message){console.warn(message);},djAdded:function(message){this.views.users.update();},djRemoved:function(message){$(message.user).each(function(index,user){ttTools.views.users.updateUser(user.userid);});},roomChanged:function(message){ttObjects.getApi();ttObjects.getManager();this.userActivityLog.init();this.autoDJ.setEnabled(false);this.animations.setEnabled(this.animations.enabled());this.override_idleTime();this.override_removeDj();this.override_guestListName();this.override_updateGuestList();this.override_connectRoomSocket();},songChanged:function(message){this.downVotes.downvoters=[];this.downVotes.downvotes=0;this.views.users.update();this.autoVote.execute();},userBooted:function(message){delete this.userActivityLog[message.userid];},userRemoved:function(message){$(message.user).each(function(index,user){delete this.userActivityLog[user.userid];});},userSpoke:function(message){this.userActivityLog[message.userid].message=util.now();this.views.users.updateUser(message.userid);},votesUpdated:function(message){this.downVotes.update(message.room.metadata);this.views.users.updateVoteCount();},autoVote:{timeout:null,enabled:function(){var enabled=$.cookie('ttTools_autoVote_enabled');if(enabled===null||enabled==='false')return false;return enabled;},setEnabled:function(enabled){$.cookie('ttTools_autoVote_enabled',enabled);},delay:function(){var delay=$.cookie('ttTools_autoVote_delay');return delay===null?(30*ttTools.constants.time.seconds):parseInt(delay);},setDelay:function(delay){$.cookie('ttTools_autoVote_delay',delay);},execute:function(){clearTimeout(this.timeout);var enabled=this.enabled();if(enabled){this.timeout=setTimeout(function(){turntable.whenSocketConnected(function(){ttObjects.room.connectRoomSocket(enabled);});},this.delay());}}},autoDJ:{timeout:null,enabled:function(){var enabled=$.cookie('ttTools_autoDJ_enabled');return enabled===null?false:enabled==='true';},setEnabled:function(enabled){$.cookie('ttTools_autoDJ_enabled',enabled);},delay:function(){var delay=$.cookie('ttTools_autoDJ_delay');return delay===null?(2*ttTools.constants.time.seconds):parseInt(delay);},setDelay:function(delay){$.cookie('ttTools_autoDJ_delay',delay);},execute:function(uid){clearTimeout(this.timeout);if(this.enabled()&&uid!==turntable.user.id&&!ttObjects.room.isDj()){this.timeout=setTimeout(function(){if(ttObjects.room.numDjs()<ttObjects.room.maxDjs){ttObjects.api({api:"room.add_dj",roomid:ttObjects.room.roomId},function(response){if(!response.success&&!ttObjects.room.isDj())return;ttTools.autoDJ.setEnabled(false);ttTools.views.toolbar.update();});}},this.delay());}}},animations:{enabled:function(){var enabled=$.cookie('ttTools_animations_enabled');return enabled===null?true:enabled==='true';},setEnabled:function(enabled){$.cookie('ttTools_animations_enabled',enabled);enabled?ttTools.animations.enable():ttTools.animations.disable();},enable:function(){if(ttObjects.manager.add_animation_to_ttTools)
ttObjects.manager.add_animation_to=ttObjects.manager.add_animation_to_ttTools;if(ttObjects.manager.speak_ttTools)
ttObjects.manager.speak=ttObjects.manager.speak_ttTools;$(Object.keys(ttObjects.manager.djs_uid)).each(function(index,uid){var dancer=ttObjects.manager.djs_uid[uid][0];if(uid===ttObjects.room.currentDj)
return ttObjects.manager.add_animation_to(dancer,'bob');if($.inArray(uid,ttObjects.room.upvoters)>-1)
return ttObjects.manager.add_animation_to(dancer,'rock');});$(Object.keys(ttObjects.manager.listeners)).each(function(index,uid){var dancer=ttObjects.manager.listeners[uid];if($.inArray(uid,ttObjects.room.upvoters)>-1)
return ttObjects.manager.add_animation_to(dancer,'rock');});},disable:function(){ttObjects.manager.add_animation_to_ttTools=ttObjects.manager.add_animation_to;ttObjects.manager.add_animation_to=$.noop;ttObjects.manager.speak_ttTools=ttObjects.manager.speak;ttObjects.manager.speak=$.noop;$(Object.keys(ttObjects.manager.djs_uid)).each(function(index,uid){ttObjects.manager.djs_uid[uid][0].stop();});$(Object.keys(ttObjects.manager.listeners)).each(function(index,uid){ttObjects.manager.listeners[uid].stop();});}},idleIndicator:{threshold:function(){var threshold=$.cookie('ttTools_idleIndicator_threshold');return threshold===null?(60*ttTools.constants.time.minutes):parseInt(threshold);},setThreshold:function(threshold){$.cookie('ttTools_idleIndicator_threshold',threshold);}},userActivityLog:{init:function(){var users=Object.keys(ttObjects.room.users);$(users).each(function(index,uid){ttTools.userActivityLog.initUser(uid);});},initUser:function(uid){if(typeof ttTools.userActivityLog[uid]==='undefined'){ttTools.userActivityLog[uid]={message:util.now(),vote:util.now()}}
return ttTools.userActivityLog[uid];},vote:function(uid){var activity=ttTools.userActivityLog.initUser(uid);return activity.vote;},message:function(uid){var activity=ttTools.userActivityLog.initUser(uid);return activity.message;},averageActivity:function(uid){var activities=ttTools.userActivityLog.initUser(uid),keys=Object.keys(activities),total=0;$(keys).each(function(index,activity){total+=activities[activity];});return util.now()-(total/keys.length);}},downVotes:{downvotes:0,downvoters:[],update:function(metadata){this.downvotes=metadata.downvotes;$(metadata.votelog).each(function(index,vote){if(vote[0]==='')return;ttTools.userActivityLog[vote[0]].vote=util.now();if(vote[1]==='up'){var downIndex=$.inArray(vote[0],ttTools.downVotes.downvoters);if(downIndex>-1){ttTools.downVotes.downvoters.splice(downIndex,1);}}else{ttTools.downVotes.downvoters.push(vote[0]);}
ttTools.views.users.updateUser(vote[0]);});}},override_guestListName:function(){Room.layouts.guestListName_ttTools=Room.layouts.guestListName;Room.layouts.guestListName=function(user,room,selected){var tree=this.guestListName_ttTools(user,room,selected);var div=tree[0].split('.');div[0]+='#'+user.userid;tree[0]=div.join('.');return tree;}},override_updateGuestList:function(){ttObjects.room.updateGuestList_ttTools=ttObjects.room.updateGuestList;ttObjects.room.updateGuestList=function(){this.updateGuestList_ttTools();ttTools.views.users.update();}},override_idleTime:function(){turntable.idleTime=function(){return 0;};},override_removeDj:function(){ttObjects.room.removeDj_ttTools=ttObjects.room.removeDj;ttObjects.room.removeDj=function(uid){ttTools.autoDJ.execute();this.removeDj_ttTools(uid);}},override_connectRoomSocket:function(){ttObjects.room.connectRoomSocket_ttTools=ttObjects.room.connectRoomSocket;ttObjects.room.connectRoomSocket=function(vote){clearTimeout(ttTools.autoVote.timeout);ttObjects.room.connectRoomSocket_ttTools(vote);}},checkVersion:function(){if(parseInt($.cookie('ttTools_release'))!==ttTools.release){$.cookie('ttTools_release',ttTools.release);this.views.info.render();}},timestamp:function(millis){millis=util.now()-millis;if(millis<ttTools.constants.time.minutes)
return Math.round(millis/ttTools.constants.time.seconds)+'s';if(millis<ttTools.constants.time.hours)
return Math.round(millis/ttTools.constants.time.minutes)+'m';if(millis<ttTools.constants.time.days)
return Math.round(100*(millis/ttTools.constants.time.hours))/100+'h';return Math.round(1000*(millis/ttTools.constants.time.days))/1000+'d';}}
ttTools.constants={whatsNew:"\
    <h2>What's New in ttTTools?</h2>\
    <br />\
    <h3>March 24</h3>\
    <ul>\
      <li>Fixed autoDJ</li>\
      <li>Added 'roll' button</li>\
      <li>Updated &amp; brought back import/export</li>\
      <li>Status indicators now change based on the user's average time since last activity</li>\
      <li>Popout guest list now shows number of users in room</li>\
      <li>Added logic to cancel autovote/autodj if the user manually votes or becomes a dj</li>\
    </ul>\
    <br/>\
  ",donateButton:"\
    <h3>Do you &lt;3 ttTools?</h3>\
    <form action='https://www.paypal.com/cgi-bin/webscr' method='post' target='_blank'>\
    <input type='hidden' name='cmd' value='_s-xclick'>\
    <input type='hidden' name='hosted_button_id' value='ZNTHAXPNKMKBN'>\
    <input type='image' src='https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif' border='0' name='submit' alt='PayPal - The safer, easier way to pay online!'>\
    <img alt='' border='0' src='https://www.paypalobjects.com/en_US/i/scr/pixel.gif' width='1' height='1'>\
    </form>\
    <br />\
  ",submitIssue:"\
    <h3>Found a bug? Want a feature?</h3>\
    <p>\
      It's impossible to keep track of bugs and feature requests unless they're centralized.<br/>\
      <a href='https://github.com/egeste/ttTools/issues' target='_blank'>Please submit all bugs and feature requests here.</a>\
    </p>\
    <br/>\
  ",time:{seconds:1000,minutes:60*1000,hours:60*60*1000,days:24*60*60*1000,weeks:7*24*60*60*1000,months:30*7*24*60*60*1000,years:365*30*7*24*60*60*1000},hackers:['4deadb0f4fe7d013dc0555f1','4e42c21b4fe7d02e6107b1ff','4e55144e4fe7d02a3f2c486a','4dee9d454fe7d0589304d644','4e0b4de14fe7d076b205e657','4e596d44a3f7517501058e25','4ddb2be9e8a6c45f6f000125','4dee6cd24fe7d05893018656',]}
ttTools.views={menu:{render:function(){$('<div class="menuItem">ttTools</div>').click(function(e){ttTools.views.settings.render();}).insertBefore($('div#menuh').children().last());}},settings:{render:function(){util.showOverlay(util.buildTree(this.tree()));$('div.settingsOverlay.modal').append(ttTools.constants.submitIssue).append(ttTools.constants.donateButton);$('<style/>',{type:'text/css',text:"\
div.field.settings { padding:10px 20px; }\
div.field.settings .ui-slider {\
  height:0.5em;\
  margin:10px 0 3px;\
}\
div.field.settings .ui-slider .ui-slider-handle {\
  width:0.9em;\
  height:0.9em;\
}\
div#idleIndicatorDisplay, div#autoDJDisplay, div#autoVoteDisplay { text-align:center; }\
      "}).appendTo($('div.settingsOverlay.modal'));$('div#idleIndicatorThreshold').slider({min:10*ttTools.constants.time.minutes,max:60*ttTools.constants.time.minutes,step:ttTools.constants.time.minutes,value:ttTools.idleIndicator.threshold(),slide:function(event,ui){ttTools.idleIndicator.setThreshold(ui.value);$('div#idleIndicatorDisplay').text((ui.value/ttTools.constants.time.minutes)+'m');}});$('div#autoDJDelay').slider({min:0,max:5*ttTools.constants.time.seconds,step:ttTools.constants.time.seconds/10,value:ttTools.autoDJ.delay(),slide:function(event,ui){ttTools.autoDJ.setDelay(ui.value)
$('div#autoDJDisplay').text((ui.value/ttTools.constants.time.seconds)+'s');}});$('div#autoVoteDelay').slider({min:0,max:60*ttTools.constants.time.seconds,step:ttTools.constants.time.seconds,value:ttTools.autoVote.delay(),slide:function(event,ui){ttTools.autoVote.setDelay(ui.value);$('div#autoVoteDisplay').text((ui.value/ttTools.constants.time.seconds)+'s');}});},tree:function(){return['div.settingsOverlay.modal',{},['div.close-x',{event:{click:util.hideOverlay}}],['h1','ttTools'],['div',{},'Released: '+(new Date(ttTools.release*ttTools.constants.time.seconds)).toGMTString()],['br'],['div.fields',{},['div.field.settings',{},['div',{},'Idle Indicator Threshold'],['div#idleIndicatorThreshold',{}],['div#idleIndicatorDisplay',{},(ttTools.idleIndicator.threshold()/ttTools.constants.time.minutes)+'m'],['br'],['div',{},'Auto DJ Delay'],['div#autoDJDelay',{}],['div#autoDJDisplay',{},(ttTools.autoDJ.delay()/ttTools.constants.time.seconds)+'s'],['br'],['div',{},'Auto Vote Delay'],['div#autoVoteDelay',{}],['div#autoVoteDisplay',{},(ttTools.autoVote.delay()/ttTools.constants.time.seconds)+'s']],]];}},info:{render:function(){turntable.showAlert();$('<style/>',{type:'text/css',text:"\
div.modal { margin-top:15px !important; }\
div.modal ul li {\
  font-size:16px;\
  text-align:left;\
}\
      "}).appendTo($('div.modal'));$('div.modal div:first').html('').append(ttTools.constants.whatsNew).append(ttTools.constants.submitIssue).append(ttTools.constants.donateButton);}},toolbar:{render:function(){turntable.playlist.setPlaylistHeightFunc=turntable.playlist.setPlaylistHeight;turntable.playlist.setPlaylistHeight=function(a){var a=this.setPlaylistHeightFunc(a);$(turntable.playlist.nodes.root).find(".queueView .songlist").css({height:Math.max(a-120,55)});return a;}
turntable.playlist.setPlaylistHeight($('div.chat-container').css('top').replace('px',''));$('<style/>',{type:'text/css',text:"\
div.resultsLabel {\
  top:65px !important;\
  height:20px !important;\
  padding-top:7px !important;\
  background-color:#CCC !important;\
}\
div.songlist {\
  font-size:0.5em;\
  top:95px !important;\
}\
div#playlistTools {\
  left:0;\
  right:0;\
  top:65px;\
  height:2em;\
  padding:2px 0;\
  position:absolute;\
}\
div#playlistTools label { font-size:5px; }\
div#playlistTools button { width:auto; height:auto; }\
div#playlistTools button .ui-button-text { padding:.6em; }\
div#playlistTools button .custom-icons { background:url(https://github.com/egeste/ttTools/raw/master/images/custom-icons.png); }\
div#playlistTools button .custom-icons.youtube { background-position:0 0; }\
div#playlistTools button .custom-icons.dice { background-position:17px 0; }\
div#playlistTools button .custom-icons.soundcloud { background-position:34px 0; }\
div#playlistTools div, #playlistTools button { float:left; }\
div#switches { margin:0 3px; }\
div#switches ui-button-text { padding:0.6em 1em; }\
      "}).appendTo(document.head);$(util.buildTree(this.tree())).insertAfter($('form.playlistSearch'));$('div#switches').buttonset();$('input#autoAwesome').click(function(e){if(ttTools.autoVote.enabled()!=='up')ttTools.autoVote.setEnabled('up');else ttTools.autoVote.setEnabled('false');ttTools.views.toolbar.update();ttTools.autoVote.execute();}).prop('checked',ttTools.autoVote.enabled()==='up').button('refresh');$('input#autoLame').click(function(e){if(ttTools.autoVote.enabled()!=='down')ttTools.autoVote.setEnabled('down');else ttTools.autoVote.setEnabled('false');ttTools.views.toolbar.update();ttTools.autoVote.execute();}).prop('checked',ttTools.autoVote.enabled()==='down').button('refresh');$('input#autoDJ').click(function(e){ttTools.autoDJ.setEnabled(!ttTools.autoDJ.enabled());ttTools.autoDJ.execute();}).prop('checked',ttTools.autoDJ.enabled()).button('refresh');$('input#animations').click(function(e){ttTools.animations.setEnabled(!ttTools.animations.enabled());}).prop('checked',ttTools.animations.enabled()).button('refresh');$('button#youtube').button({text:false,icons:{primary:'custom-icons youtube'}}).click(function(e){if(!ttObjects.room.currentSong)return;var metadata=ttObjects.room.currentSong.metadata;var uri='http://www.youtube.com/results?search_query=';uri+=encodeURIComponent(metadata.artist+' - '+metadata.song);window.open(uri,'_blank');});$('button#soundcloud').button({text:false,icons:{primary:'custom-icons soundcloud'}}).click(function(e){if(!ttObjects.room.currentSong)return;var metadata=ttObjects.room.currentSong.metadata;var uri='http://soundcloud.com/search?q[fulltext]=';uri+=encodeURIComponent(metadata.artist+' - '+metadata.song);window.open(uri,'_blank');});$('button#casinoRoll').button({text:false,icons:{primary:'custom-icons dice'}}).click(function(e){$('div.chat-container form input').val('roll').parent().submit();});$('button#showTheLove').button({text:false,icons:{primary:'ui-icon-heart'}}).click(function(e){var maxOffset=200*Object.keys(ttObjects.room.users).length;for(user in ttObjects.room.users){setTimeout(function(user){ttObjects.manager.show_heart(user);},Math.round(Math.random()*maxOffset),user);}});$('button#importExport').button({text:false,icons:{primary:'ui-icon-transferthick-e-w'}}).click(function(e){ttTools.portability.views.modal.render();});},tree:function(){return['div#playlistTools',{},['div#switches',{},['input#autoAwesome',{type:'checkbox'}],['label',{'for':'autoAwesome'},['span.ui-icon.ui-icon-circle-arrow-n',{title:'Automatically upvote songs'}],],['input#autoLame',{type:'checkbox'}],['label',{'for':'autoLame'},['span.ui-icon.ui-icon-circle-arrow-s',{title:'Automatically downvote songs'}],],['input#autoDJ',{type:'checkbox'}],['label',{'for':'autoDJ'},['span.ui-icon.ui-icon-person',{title:'Attempt to get the next DJ spot'}],],['input#animations',{type:'checkbox'}],['label',{'for':'animations'},['span.ui-icon.ui-icon-video',{title:'Toggle animations on/off'}]],],['button#youtube',{title:'Search YouTube'}],['button#soundcloud',{title:'Search SoundCloud'}],['button#casinoRoll',{title:'Roll for a spot (casino mode)'}],['button#showTheLove',{title:'Show The Love'}],['button#importExport',{title:'Import/Export'}]];},update:function(){$('#autoDJ').prop('checked',ttTools.autoDJ.enabled()).button('refresh');$('#autoAwesome').prop('checked',ttTools.autoVote.enabled()==='up').button('refresh');$('#autoLame').prop('checked',ttTools.autoVote.enabled()==='down').button('refresh');}},users:{render:function(){$('<style/>',{type:'text/css',text:"\
div.guest.upvoter { background-color:#aea !important;}\
div.guest.upvoter:hover { background-color:#cec !important; }\
div.guest.downvoter { background-color:#eaa !important; }\
div.guest.downvoter:hover { background-color:#ecc !important; }\
div.guest.current_dj { background-color:#ccf !important; }\
div.guest.current_dj:hover { background-color:#ddf !important; }\
div.guestName .emoji { padding:3px 0; margin-left:3px; }\
div.guestName .status {\
  padding:0 7px;\
  margin:0 3px 0 -3px;\
  background-image:url('https://s3.amazonaws.com/static.turntable.fm/images/pm/status_indicators_depth.png');\
}\
div.guestName .status.green { background-position:0 0; }\
div.guestName .status.yellow { background-position:0 -13px; }\
div.guestName .status.grey { background-position:0 -26px; }\
div.guestName .status.red { background-position:0 -39px; }\
div#voteCount {\
  position:absolute;\
  top:3px;\
  right:20px;\
  font-size:12px;\
  text-shadow:-1px 0 black,0 1px black,1px 0 black,0 -1px black;\
}\
div#voteCount span.up { color:#aea; }\
div#voteCount span.down { color:#eaa; }\
div.guestButton {\
  width: 35px;\
  height: 36px;\
  cursor: pointer;\
  background:none;\
  position: absolute;\
  border: 0;\
  border-left: 1px solid #D0D0D0;\
  border-right: 1px solid #7B7B7B;\
}\
div.guestButton.popout { left: 36px; }\
div.ui-icon { margin:10px; }\
div.guestListSize {\
  left:73px !important;\
  width:157px !important;\
  font-size:11px !important;\
}\
div#guestDialog { padding:0; }\
div#guestDialog div.guest-list-container {\
  top:auto !important;\
  height:auto !important;\
  position:relative;\
}\
div#guestDialog div.guest-list-container div.guests {\
  top:0;\
  height:auto !important;\
  overflow:hidden;\
  background:none;\
  position:relative;\
}\
      "}).appendTo(document.head);$('<div/>',{id:'voteCount'}).appendTo($('div.chatHeader'));ttObjects.room.updateGuestList();this.update();$('<div/>',{id:'guestDialog'}).appendTo(document.body);this.setupDialog();},setupDialog:function(){$('div#guestDialog').dialog({width:285,height:350,title:' people are in this room',autoOpen:false,open:function(e,ui){$('div.chat-container div.guestListButton').hide();$('div.chat-container div.guestButton').show();$('div.guest-list-container').appendTo(this);$('div.guest-list-container div.chatBar').hide();$('div.guest-list-container div.chatHeader').hide();$('div#guestDialog').prev().find('span:first').prepend($('span#totalUsers'));},close:function(e,ui){$('div.chat-container div.guestListButton').show();$('div.chat-container div.guestButton').hide();$('div.guest-list-container').appendTo($('div#right-panel'));$('div.guest-list-container div.chatBar').show();$('div.guest-list-container div.chatHeader').show();$('span#totalUsers').prependTo('div.guestListSize');}});$('div.guest-list-container div.guestListButton').after($('<div/>',{'class':'guestButton ui-state-default popout'}).append($('<div/>',{'class':'ui-icon ui-icon-newwin'})).bind('click',function(e){$('div#guestDialog').dialog('open');}));$('div.chat-container div.guestListButton').after($('<div/>',{'class':'guestButton ui-state-default',style:'border-left:0;'}).hide().append($('<div/>',{'class':'ui-icon ui-icon-pin-w'})).bind('click',function(e){$('div#guestDialog').dialog('close');}));},update:function(){ttTools.views.users.updateVoteCount();$('div.guests .guest').each(function(index,element){ttTools.views.users.updateUser(element.id);});},updateVoteCount:function(){$('div#voteCount').html('').append(util.emojify(':thumbsup:')).append($('<span/>',{'class':'up'}).html(ttObjects.room.upvoters.length)).append('&nbsp;&nbsp;&nbsp;').append(util.emojify(':thumbsdown:')).append($('<span/>',{'class':'down'}).html(ttTools.downVotes.downvotes))},updateUser:function(uid){var guest=$('div#'+uid);var guestName=guest.find('div.guestName');var user=ttObjects.room.users[uid];guest.find('span').remove();guest.attr('class','guest');if(uid===ttObjects.room.currentDj)guest.addClass('current_dj');if($.inArray(uid,ttObjects.room.upvoters)>-1)guest.addClass('upvoter');if($.inArray(uid,ttTools.downVotes.downvoters)>-1)guest.addClass('downvoter');guestName.prepend($('<span/>').addClass('status').addClass(ttTools.views.users.userStatus(uid)).hover(function(e){var title='Last spoke '+ttTools.timestamp(ttTools.userActivityLog.message(uid))+' ago';title+="\n";title+='Last voted '+ttTools.timestamp(ttTools.userActivityLog.vote(uid))+' ago';$(this).attr('title',title).attr('class','status').addClass(ttTools.views.users.userStatus(uid));}));if(user.verified)
guestName.append($(util.emojify(':tophat:')).attr('title','Verified '+user.verified));if($.inArray(uid,ttTools.constants.hackers)>-1)
guestName.append($(util.emojify(':octocat:')).attr('title','turntable.fm hacker'));if($.inArray(uid,ttObjects.room.djIds)>-1)
guestName.append($(util.emojify(':notes:')).attr('title','Is on the decks'));},userStatus:function(uid){var averageActivity=ttTools.userActivityLog.averageActivity(uid);var threshold=ttTools.idleIndicator.threshold();if(averageActivity>threshold)return'red';if(averageActivity>(threshold/2))return'yellow';return'green';}}}
ttTools.database={dbName:'ttTools.database',dbDisplayName:'ttTools Database',dbVersion:'1.0',dbMaxSize:10000000,dbHandle:false,isSupported:function(){return window.openDatabase?true:false;},getDatabase:function(){if(this.dbHandle){return this.dbHandle;}
this.dbHandle=openDatabase(this.dbName,this.dbVersion,this.dbDisplayName,this.dbMaxSize);return this.dbHandle;},execute:function(query,success,failure){console.log(query);this.getDatabase().transaction(function(transaction){transaction.executeSql(query,[],success,failure);});}}
ttTools.tags={dbTable:'tags',loadRetry:30,load:function(retry){if(!ttTools.database.isSupported())return;if(!turntable.playlist||turntable.playlist.files==0){if(retry>ttTools.tags.loadRetry){return alert('Could not load ttTools tagging.');}
var callback=function(){ttTools.tags.load(retry++);}
return setTimeout(callback,1000);}
ttTools.tags.init();},init:function(){$('<style/>',{type:'text/css',text:"\
div.tagsinput { border:1px solid #CCC; background: #FFF; padding:5px; width:300px; height:100px; overflow-y: auto;}\
div.tagsinput span.tag { border: 1px solid #a5d24a; -moz-border-radius:2px; -webkit-border-radius:2px; display: block; float: left; padding: 5px; text-decoration:none; background: #cde69c; color: #638421; margin-right: 5px; margin-bottom:5px;font-family: helvetica;  font-size:13px;}\
div.tagsinput span.tag a { font-weight: bold; color: #82ad2b; text-decoration:none; font-size: 11px;  }\
div.tagsinput input { width:80px; margin:0px; font-family: helvetica; font-size: 13px; border:1px solid transparent; padding:5px; background: transparent; color: #000; outline:0px;  margin-right:5px; margin-bottom:5px; }\
div.tagsinput div { display:block; float: left; }\
.tags_clear { clear: both; width: 100%; height: 0px; }\
.not_valid {background: #FBD8DB !important; color: #90111A !important;}\
div.song div.ui-icon-tag {\
  margin: 0;\
  top: 24px;\
  right: 5px;\
  width: 16px;\
  height: 16px;\
  cursor: pointer;\
  position: absolute;\
}\
    "}).appendTo(document.head);ttTools.tags.createTable();ttTools.tags.updateQueue();ttTools.tags.addSongOverride();ttTools.tags.filterQueueOverride();},updateQueue:function(){var elements=$('div.song').unbind('click').click(function(e){ttTools.tags.views.add.file=$(this).closest('.song').data('songData');ttTools.tags.views.add.render();});$('div.song div.ui-icon-tag').remove();this.getFids(function(tx,result){var fids=[];for(var i=0;i<result.rows.length;i++){fids.push(result.rows.item(i).fid);}
elements.each(function(index,element){element=$(element);var fid=element.closest('.song').data('songData').fileId;if($.inArray(fid,fids)>-1){$('<div/>',{'class':'ui-icon ui-icon-tag',title:'This song is ttTagged'}).appendTo(element);}});});},addSongOverride:function(){turntable.playlist.addSong_ttTools=turntable.playlist.addSong;turntable.playlist.addSong=function(b,a){turntable.playlist.addSong_ttTools(b,a);ttTools.tags.updateQueue();}},filterQueueOverride:function(){turntable.playlist.filterQueue_ttTools=turntable.playlist.filterQueue;turntable.playlist.filterQueue=function(filter){turntable.playlist.filterQueue_ttTools(filter);if(filter.length>0){ttTools.tags.getFidsForTagLike(filter,function(tx,result){var fids=[];for(var i=0;i<result.rows.length;i++){fids.push(result.rows.item(i).fid);}
$('div.queue div.song:hidden').each(function(index,value){var element=$(value);var fid=element.data('songData').fileId;if($.inArray(fid,fids)>-1){element.closest('.song').show().addClass('filtered');}});});}}},createTable:function(){ttTools.database.execute('CREATE TABLE IF NOT EXISTS '+
this.dbTable+'('+'id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,'+'fid TEXT NOT NULL,'+'tag TEXT NOT NULL'+');');},resetData:function(){ttTools.database.execute('DROP TABLE IF EXISTS '+this.dbTable+';');this.createTable();this.addTag('4dd6c222e8a6c404330002c5','trololo');ttTools.tags.updateQueue();},getAll:function(success,failure){return ttTools.database.execute('SELECT DISTINCT fid, tag FROM '+this.dbTable+';',success,failure);},getFids:function(success,failure){return ttTools.database.execute('SELECT DISTINCT fid FROM '+this.dbTable+';',success,failure);},getFidsForTag:function(tag,success,failure){return ttTools.database.execute('SELECT DISTINCT fid FROM '+this.dbTable+' WHERE tag="'+tag+'";',success,failure);},getFidsForTagLike:function(tag,success,failure){return ttTools.database.execute('SELECT DISTINCT fid FROM '+this.dbTable+' WHERE tag LIKE "%'+tag+'%";',success,failure);},getTagsForFid:function(fid,success,failure){return ttTools.database.execute('SELECT DISTINCT tag FROM '+this.dbTable+' WHERE fid="'+fid+'";',success,failure);},addTag:function(fid,tag,success,failure){return ttTools.database.execute('INSERT INTO '+this.dbTable+' (fid,tag) VALUES("'+fid+'", "'+tag+'");',success,failure);},removeTag:function(fid,tag,success,failure){return ttTools.database.execute('DELETE FROM '+this.dbTable+' WHERE fid="'+fid+'" AND tag="'+tag+'";',success,failure);}}
ttTools.tags.views={add:{file:null,render:function(){util.showOverlay(util.buildTree(this.tree()));var file=this.file;ttTools.tags.getAll(function(tx,result){var tags={};for(var i=0;i<result.rows.length;i++){tags[result.rows.item(i).tag]=1;}
var tags=Object.keys(tags);$('#tags').tagsInput({width:'100%',onAddTag:function(tag){ttTools.tags.addTag(file.fileId,tag);},onRemoveTag:function(tag){ttTools.tags.removeTag(file.fileId,tag);},autocomplete_url:false,autocomplete:{source:tags}});});ttTools.tags.getTagsForFid(this.file.fileId,function(tx,result){for(var i=0;i<result.rows.length;i++){$('#tags').addTag(result.rows.item(i).tag,{callback:false});}});},tree:function(){return['div.settingsOverlay.modal',{},['div.close-x',{event:{click:function(){util.hideOverlay();ttTools.tags.updateQueue();}}}],['br'],['h1',this.file.metadata.song],['div',{},this.file.metadata.artist],['br'],['input#tags',{type:'text'}]];}}}
ttTools.portability={init:function(){this.views.import.render();},importProcess:{operations:[],completed:0,timeout:null},importPlaylist:function(playlist){if(playlist.length==0){return this.views.import.update();}
this.importProcess.operations=[];this.importProcess.completed=0;$(playlist).each(function(index,song){if($.inArray(song.fileId,Object.keys(turntable.playlist.songsByFid))>-1){return;}
var operation=function(count){count=(count==undefined)?1:count;if(count>3){ttTools.portability.importOperations.splice(ttTools.portability.importProcess.completed,1);ttTools.portability.views.import.update();}
var deferredRetry=function(){operation(count++);}
ttTools.portability.importProcess.timeout=setTimeout(deferredRetry,10000);var apiCallback=function(response){clearTimeout(ttTools.portability.importProcess.timeout);if(!response.success){return operation(count++);}
ttTools.portability.importProcess.completed++;ttTools.portability.views.import.update();turntable.playlist.files.push(song);turntable.playlist.songsByFid[song.fileId]=song;turntable.playlist.updatePlaylist();if(ttTools.database.isSupported()&&song.tags){ttTools.tags.getTagsForFid(song.fileId,function(tx,result){var tags=[];for(var i=0;i<result.rows.length;i++){tags.push(result.rows.item(i).tag);}
$(song.tags).each(function(index,tag){if($.inArray(tag,tags)<0){ttTools.tags.addTag(song.fileId,tag,function(tx,result){ttTools.tags.updateQueue();});}});})}
if(ttTools.portability.importProcess.operations[ttTools.portability.importProcess.completed]){ttTools.portability.importProcess.operations[ttTools.portability.importProcess.completed]();}}
var deferredOperation=function(){ttObjects.api({api:'playlist.add',playlist_name:'default',index:turntable.playlist.files.length+1,song_dict:{fileid:song.fileId}},apiCallback);}
setTimeout(deferredOperation,1500);}
ttTools.portability.importProcess.operations.push(operation);});if(this.importProcess.operations.length==0){return this.views.import.update();}
this.importProcess.operations[0]();},exportPlaylist:function(tags){if(!ttTools.database.isSupported()||(tags.length<2&&tags[0]=='')){return window.location.href='data:text/json;charset=utf-8,'+JSON.stringify(turntable.playlist.files);}
ttTools.tags.getAll(function(tx,result){var tagsByFid={},matchFids=[];for(var i=0;i<result.rows.length;i++){if(tagsByFid[result.rows.item(i).fid]){tagsByFid[result.rows.item(i).fid].push(result.rows.item(i).tag);}else{tagsByFid[result.rows.item(i).fid]=[result.rows.item(i).tag];}
if($.inArray(result.rows.item(i).tag,tags)>-1){matchFids.push(result.rows.item(i).fid);}}
var playlist=[];$(turntable.playlist.files).each(function(index,file){if($.inArray(file.fileId,matchFids)>-1)playlist.push(file);});if(playlist.length<1){return turntable.showAlert("You have no music tagged with "+tags.join(', '));}
return window.location.href='data:text/json;charset=utf-8,'+JSON.stringify(playlist);});}}
ttTools.portability.views={import:{render:function(){$('<style/>',{type:'text/css',text:"\
div#importProgress {\
  top:0;\
  left:0;\
  color:#fff;\
  width:400px;\
  padding:20px;\
  z-index:1000;\
  text-align:center;\
  position:absolute;\
  background-color:#888;\
  border:13px solid #fbd863;\
  text-shadow:1px 1px 1px black;\
}\
      "}).appendTo(document.head);$(util.buildTree(this.tree())).appendTo(document.body).draggable().hide().find('div#importProgressBar').progressbar();},update:function(){var total=ttTools.portability.importProcess.operations.length;var completed=ttTools.portability.importProcess.completed;$('span#importTotal').html(total);$('span#importCount').html(completed);$('div#importProgressBar').progressbar('option','value',(completed/total)*100);if(completed==total){if(ttTools.database.isSupported())ttTools.tags.updateQueue();$('div#importProgress').hide();}},tree:function(){return['div#importProgress',{},['span#status',{},'Processing...'],['div#importProgressBar',{}],['span#importCount',{},'0'],['span',{},' of '],['span#importTotal',{},'0'],['div',{},'Please be patient, this process is slow. Feel free to drag this dialog out of the way.']];}},modal:{render:function(){util.showOverlay(util.buildTree(this.tree()));$('<style/>',{type:'text/css',text:"\
div.portability.modal.dropzone { border-style:dotted; }\
div.portability.modal.dropzone * { visibility: hidden; }\
div.portability.modal ul { text-align: left; }\
div.portability.modal div.rightAlign { text-align: right; }\
      "}).appendTo($('div.portability.modal'));ttTools.tags.getAll(function(tx,result){var tags={};for(var i=0;i<result.rows.length;i++){tags[result.rows.item(i).tag]=1;}
var tags=Object.keys(tags);$('input#tagExport').tagsInput({width:'100%',defaultText:'Export tags',autocomplete_url:false,autocomplete:{source:tags}});});$('button#tagExportButton').button().click(function(e){var tags=$('input#tagExport').val().split(',');util.hideOverlay();ttTools.portability.exportPlaylist(tags);});$('div.portability.modal').on('dragenter',function(e){$(this).addClass('dropzone');}).on('dragleave',function(e){$(this).removeClass('dropzone');}).on('dragover',function(e){e.preventDefault();}).on('drop',function(e){e=e.originalEvent;util.hideOverlay();for(var i=0;i<e.dataTransfer.files.length;i++){var file=e.dataTransfer.files[i];var reader=new FileReader();reader.onload=function(){$('div#importProgress').show().find('span#status').html('Processing: '+file.name);try{ttTools.portability.importPlaylist(JSON.parse(this.result));}catch(err){$('div#importProgress').hide();alert(file.name+' cannot be imported as a playlist.');}}
reader.readAsText(file,'utf-8');}});},tree:function(){return['div.portability.modal',{},['div.close-x',{event:{click:util.hideOverlay}}],['h1','Import/Export'],['br'],['ul',{},['li',{},'To import a playlist, simply drag & drop the file on this dialog'],['li',{},'To export your entire playlist, just click export.'],['li',{},'To only export songs with specific tags, enter them in the field below, then click export.']],['input#tagExport',{type:'text'}],['br'],['div.rightAlign',{},['button#tagExportButton','Export'],],];}}}
ttTools.release=1332578556;ttTools.load(0);